---
author: "Marina Rodes Blanco, Juli√°n Tijerin Trivi√±o, Paloma Ruiz Benito y Ver√≥nica Cruz Alonso, "
date: today
date-format: "DD/MM/YYYY"
toc: true
toc-depth: 5
toc-title: "√çndice"
format:
  html:
    link-external-newwindow: true
    title: D√≠a 2 - Manejo y visualizaci√≥n de datos en R
    subtitle: Gesti√≥n de datos y funciones en R
  gfm: 
    title: "D√≠a 2 - Manejo y visualizaci√≥n de datos en R"
editor: visual
editor_options: 
  chunk_output_type: console
number-sections: true
bibliography: references.bib
---

## S√≠ntesis del d√≠a 1: Introducci√≥n a R y a R studio

#### üß© Ejercicio: *repaso* *del d√≠a anterior*

Crea un vector (mes) con los meses del a√±o (en n√∫mero)

Crea otro vector con el n√∫mero de d√≠as de cada mes y calcula la media y la desviaci√≥n t√≠pica

Junta los dos vectores en un data frame

```{r solucion ej repaso}

mes<-1:12

dias<-c(31,28,31,30,31,30,31,31,30,30,31,31)

mean(dias)
sd(dias)

data.frame(m=mes,
           d=dias)
```

## Manejo y gesti√≥n de datos

### Importar y renombrar datos

##### üß© *Ejercicio: slice(), filter(), arrange()*

```{=html}
<table>
  <tr>
    <td style="width:330px; vertical-align:top;">
      <img src="images/mammals_sleeping_picture1_copilot.png" style="width:300px; height:auto; display:block;">
    </td>
    <td style="vertical-align:middle;">
      <li> Lee el data.frame ‚Äúmsleep.csv‚Äù. Pista: el delimitador entre datos es la coma (‚Äú,‚Äù).</li>
      <li> Crea un subset que NO contenga los animales dom√©sticos (campo conservation). ¬øCuantas son?</li>
      <li> Crea un subset de datos que contenga las filas de la 1 a la 5 y de la 18 a la 20, sobre esos datos obten los animales carn√≠voros. Ordena seg√∫n las horas de sue√±o ¬øQu√© animal duerme m√°s horas?</li>
    </td>
  </tr>
</table>
```

```{r solucion ejercicio 1}

#Soluci√≥n ejercicio 1:slice(), filter(), arrange()
library (tidyverse)

## Leer el data frame
msleep <- read_delim(file = "data/msleep.csv", delim = ",")

head(msleep)

## Crea un subset que NO contenga los animales dom√©sticos (campo conservation). ¬øCuantas son?

msleep |>  filter(conservation != "domesticated")

#### Otras posibles soluciones...
msleep |>  filter(conservation %in% c("lc", "nt", "vu", "en", "cd", NA))
msleep |>  filter(
  conservation == "lc" | conservation == "nt" |
    conservation == "vu" | conservation == "en" |
    conservation == "cd" | is.na(conservation)
)

## Crea un subset de datos que contenga las filas de la 1 a la 5 y de la 18 a la 20, sobre esos datos obten los animales carn√≠voros. Ordena seg√∫n las horas de sue√±o ¬øQu√© animal duerme m√°s horas?

subset_msleep <- msleep |>
  slice(1:5, 18:20) |>
  filter(vore == "carni") |>
  arrange(desc(sleep_total))

#### solucion: Cheetah (guepardo)

```

### [Select](https://dplyr.tidyverse.org/reference/select.html): sirve para seleccionar columnas utilizando condiciones

##### üß© *Ejercicio: select()*

```{=html}
<table>
  <tr>
    <td style="width:330px; vertical-align:top;">
      <img src="images/mammals_sleeping_picture2_copilot.png" style="width:300px; height:auto; display:block;">
    </td>
    <td style="vertical-align:middle;">
      <li> Con el data set de msleep, crea un nuevo data.frame que contenga las variables relacionadas con el sue√±o.</li>
      <li> Crea un nuevo objeto con el orden, g√©nero y nombre al principio y que incluya todas las dem√°s columnas excepto el tiempo despierto.</li>
      <li>(extra) ¬øQue animal del orden Carnivora en estado vulnerable (conservation = vu) duerme m√°s?</li>
    </td>
  </tr>
</table>
```

```{r solucion ejercicio 2}

## Nuevo data.frame que contenga las variables relacionadas con el sue√±o
head(msleep) #para ver las 10 primeras lineas
names(msleep) #para ver el nombre de las columnas

vars_sleep <- msleep |>
  select(starts_with("sleep"))

## Nuevo objeto con el orden, g√©nero y nombre al principio y que incluya todas las dem√°s columnas excepto el tiempo despierto.
msleep2 <- msleep |>
  select(order, genus, name, everything(), -awake)

## Extra: ¬øQue animal del orden Carnivora en estado vulnerable (conservation = vu) duerme m√°s?

msleep |>
  filter(order == "Carnivora" &
           conservation == "vu") |>
  arrange(desc(sleep_total))

```

### Transformar los datos y calcular nuevas variables

##### üß© *Ejercicio: mutate()*

```{=html}

<table>
  <tr>
    <td style="width:330px; vertical-align:top;">
      <img src="images/mammals_sleeping_picture3_copilot.png" style="width:300px; height:auto; display:block;">
    </td>
    <td style="vertical-align:middle;">
      <li> Con el data set de msleep, incluye una nueva columna con el porcentaje de horas que duerme cada animal al d√≠a. </li>
      <li> Haz una clasificaci√≥n que incluya tres categor√≠as: carnivoros amenazados, herviboros amenazados y otros. Para ello tienes que basarte en las columnas ‚Äúvore‚Äù y ‚Äúconservation‚Äù. Segun la UICN se considera amenazado cuando est√° en las categor√≠as vulnerable (vu), endangered (en) o critically endangered (cr). </li>
    </td>
  </tr>
</table>
```

```{r solucion ejercicio 3}

## Nueva columna con el porcentaje de horas que duerme cada animal al d√≠a.

msleep |> mutate(sleep_prc = (sleep_total / 24) * 100)

## Haz una clasificaci√≥n que incluya tres categor√≠as: carnivoros amenazados, herviboros amenazados y otros. Para ello tienes que basarte en las columnas ‚Äúvore‚Äù y ‚Äúconservation‚Äù. Segun la UICN se considera amenazado cuando est√° en las categor√≠as vulnerable (vu), endangered (en) o critically endangered (cd).

msleep |>
  mutate(
    classification = case_when(
      # utilizar varias variables para calcular otra nueva
      vore == "carni" &
        conservation %in% c("en", "cd") ~ "threatened carnivore",
      
      vore == "herbivore" &
        conservation %in% c("en", "cd") ~ "threatened herbivore",
      
      TRUE ~ "others" #resto de casos
    )
  )

```

##### üß© *Ejercicio: group_by(), summrise()*

```{=html}
<table>
  <tr>
    <td style="width:330px; vertical-align:top;">
      <img src="images/mammals_sleeping_picture4_copilot.png" style="width:300px; height:auto; display:block;">
    </td>
    <td style="vertical-align:middle;">
      <li> Con el data set de msleep, cuenta el n√∫mero de especies estudiadas por orden (order) </li>
      <li> Calcula el promedio de horas de sue√±o seg√∫n el tipo de alimentaci√≥n ¬øduemen mas los carnivoros, los herb√≠voros o los insect√≠voros estudiados en este dataset? </li>
    </td>
  </tr>
</table>
```

```{r solucion ejercicio 4}
## Con el data set de msleep, cuenta el n√∫mero de especies estudiadas por orden (order)
msleep |>
  group_by(order) |>
  summarise(species_per_order = n())

## Otra opci√≥n, mucho m√°s segura...
msleep |>
  group_by(order) |>
  summarise(species_per_order = n_distinct(name))

## Calcula el promedio de horas de sue√±o seg√∫n el tipo de alimentaci√≥n ¬øduemen mas los carnivoros, los herb√≠voros o los insect√≠voros estudiados en este dataset?
```

##### üß© *Ejercicio: transformar datos largo ancho*

```{=html}
<table>
  <tr>
    <td style="width:330px; vertical-align:top;">
      <img src="images/pixar_image2_flickr.jpg" style="width:300px; height:auto; display:block;">
    </td>
    <td style="vertical-align:middle;">
      <li> Lee el set de datos pixar_public_response_long. En este set de datos se encuentra la puntuaci√≥n de pel√≠culas pixar por la audiencia seg√∫n tres webs diferentes: rotten tomatoes, metacritic y critics‚Äô choice. </li>
      <li> Reorganiza el set de datos para que la puntuaci√≥n de cada una de las webs se encuentre en una columna diferente </li>
      <li> (extra) ¬øCual es el promedio de puntuaci√≥n por pel√≠cula teniendo en cuenta todas las fuentes? ¬øQue pel√≠cula es la mejor y peor puntuada de media? </li>
    </td>
  </tr>
</table>
```

Fuente imagen: <https://www.flickr.com/photos/harshlight/17294952412> (CC BY 2.0)

```{r solucion ejercicio 5}
## Lee el set de datos pixar_public_response_long. En este set de datos se encuentra la puntuaci√≥n de pel√≠culas pixar por la audiencia seg√∫n tres webs diferentes: rotten tomatoes, metacritic y critics‚Äô choice.

pixar_public_response_long <- read_delim("data/pixar_public_response_long.csv")

glimpse(pixar_public_response_long)

head(pixar_public_response_long)

str(pixar_public_response_long)

## Reorganiza el set de datos para que la puntuaci√≥n de cada una de las webs se encuentre en una columna diferente

pixar_public_response_wide <- pivot_wider(pixar_public_response_long,
                                          names_from = source,
                                          values_from = value)

## (extra) ¬øCual es el promedio de puntuaci√≥n por pel√≠cula teniendo en cuenta todas las fuentes? ¬øQue pel√≠cula es la mejor y peor puntuada de media?

pixar_public_response_wide |>
  
  mutate(mean_score = (rotten_tomatoes + metacritic + critics_choice) /3) |>
  
  filter(mean_score == max(mean_score, na.rm = T) |
         mean_score == min(mean_score, na.rm = T))
```

### Unir data.frames

##### üß© *Ejercicio: \*\_join() y exportar datos*

```{=html}
<table>
  <tr>
    <td style="width:330px; vertical-align:top;">
      <img src="images/pixar_image3_flickr.jpg" style="width:300px; height:auto; display:block;">
    </td>
    <td style="vertical-align:middle;">
      <li> Lee el set de datos pixar_public_response y pixar_films </li>
      <li> Explora los dos data sets con funciones como head() para ver las primeras lineas, glimpse() o View() </li>
      <li> Une ambos datasets en uno solo para tener en un mismo data frame toda la informaci√≥n. Elige el campo m√°s apropiado de uni√≥n </li>
      <li> Guarda el nuevo set de datos como pixar_joint </li>
    </td>
  </tr>
</table>
```

Fuente imagen: <https://www.flickr.com/photos/harshlight/6988729286> (CC BY 2.0)

```{r solucion ejercicio 6}
## Lee el set de datos pixar_public_response y pixar_films
pixar_public_response <- read_delim("data/pixar_public_response.csv")
pixar_films <- read_delim("data/pixar_films.csv")

## Explora los dos data sets con funciones como head() para ver las primeras lineas, glimpse() o View()
head(pixar_public_response)
glimpse(pixar_public_response)

head(pixar_films)
glimpse(pixar_films)

## Une ambos datasets en uno solo para tener en un mismo data frame toda la informaci√≥n. Elige el campo m√°s apropiado de uni√≥n

pixar_joint <- full_join(pixar_films, pixar_public_response, by = "film")

## Guarda el nuevo set de datos como pixar_joint
write_delim(pixar_joint, file = "data/pixar_joint.csv", delim = ";")
```

### üß© *Ejercicio final*

```{=html}
<table>
  <tr>
    <td style="width:150px; vertical-align:top;">
      <img src="images/palmer_penguins.png" style="width:130px; height:auto; display:block;">
    </td>
    <td style="vertical-align:middle;">
    Queremos estudiar caracter√≠sticas f√≠sicas de los ping√ºinos y relacionarlas con el tipo de isla donde viven. Para ello, realiza las siguientes tareas utilizando exclusivamente funciones del tidyverse:
    </td>
  </tr>
</table>
```

üêß Instala el paquete penguins y c√°rgalo

```{r ejerccio final (1)}
# install.packages("palmerpenguins")
library(palmerpenguins)
```

üêß Crea un data frame denominado islands_info con dos columnas, la primera llamada "island" con los valores "Torgersen", "Biscoe", "Dream" y otra llamada "protected_area" con los valores "Si", "No", "Si"

```{r ejerccio final (2)}
islands_info<-data.frame(island=c("Torgersen", "Biscoe", "Dream"),
                         protected_area=c("Si", "No", "Si"))
```

üêßSelecciona los pinguinos que tengan picos de m√°s de 40mm (bill_length_mm) y que pesen menos de 4.5kg (recuerda que puedes ver m√°s informaci√≥n de tu dataset en ?penguins)

```{r ejerccio final (3)}
penguins_filter<- penguins |> 
  filter(bill_length_mm>40, body_mass_g <4500)
```

üêßDe los datos filtrados conserva √∫nicamente las columnas species, island, bill_length_mm, bill_depth_mm y body_mass_g

```{r ejerccio final (4)}
penguins_select<- penguins_filter |> 
  select(species, island, bill_length_mm , bill_depth_mm,body_mass_g)
```

üêßA√±ade una columna llamada bill_ratio que calcule la relaci√≥n entre longitud y profundidad del pico

```{r ejerccio final (5)}
penguins_mutate<- penguins_select |> 
  mutate(bill_ratio=bill_length_mm/bill_depth_mm)
```

üêßUne el resultado con el dataset islands_info, de forma que cada ping√ºino quede asociado a si su isla es un √°rea protegida.

```{r ejerccio final (6)}
penguins_join<- penguins_mutate |> 
  left_join(islands_info, by="island")
```

üêßCrea una columna categoria_peso con valores "ligero", "medio", "pesado"seg√∫n los umbrales que quieras o, m√°s dificil, con terciles de body_mass (consulta funcion quantile).

```{r ejerccio final (7)}
penguins_class<- penguins_join |> 
  mutate(body_mass_class=case_when(
    body_mass_g <= quantile(body_mass_g, na.rm=T, 0.33) ~ "ligero",
    body_mass_g > quantile(body_mass_g, na.rm=T, 0.33) &
      body_mass_g <= quantile(body_mass_g, na.rm=T, 0.66) ~ "medio",
    body_mass_g > quantile(body_mass_g, na.rm=T, 0.66) ~ "pesado"
  ))
```

üêßSi no lo has hecho, organiza todos los pasos anteriores (excepto cargar el paquete y crear el data frame) en un solo flujo de trabajo

```{r ejerccio final (8)}

penguins2 <- penguins |>
  
  filter(bill_length_mm > 40, body_mass_g < 4500) |>
  
  select(species , island, bill_length_mm , bill_depth_mm, body_mass_g) |>
  
  mutate(bill_ratio = bill_length_mm / bill_depth_mm) |>
  
  left_join(islands_info, by = "island") |>
  
  mutate(
    body_mass_class = case_when(
      body_mass_g <= quantile(body_mass_g, na.rm = T, 0.33) ~ "ligero",
      body_mass_g > quantile(body_mass_g, na.rm = T, 0.33) &
        body_mass_g <= quantile(body_mass_g, na.rm = T, 0.66) ~ "medio",
      body_mass_g > quantile(body_mass_g, na.rm = T, 0.66) ~ "pesado"
    )
  )

```

üêßCuenta cuantos individuos hay ligeros, medios y pesados en zonas protegidas vs zonas no protegidas

```{r ejerccio final (9)}
penguins_class |>  group_by(body_mass_class) |> summarise(n())
```

üêß(EXTRA) Responde a las siguientes preguntas: ¬øCual es la m√°xima relaci√≥n entre longitud y profundidad del pico de los individuos en zonas protegidas? ¬øy no protegidas?

```{r solucion ejercicio final}
penguins_class |> group_by(protected_area) |>  summarise(bill_ratio=max(bill_ratio))

```

## Introducci√≥n a la programaci√≥n con funciones

##### üß© Ejercicio: consultar la funci√≥n matrix()

Consulta la ayuda de la funci√≥n matrix. ¬øCuantos argumentos tiene?. Genera una matriz con esta funcion usando todos los argumentos.

```{r}

? matrix

# argumentos: 
  # data: data vector 
  # nrow: number of rows
  # ncol: number of columns
  # byrow: if the matrix is filled by columns or by rows
  # dimnames:  NULL or a list of length 2 giving the row and column names respectively. 

matrix(1:10,
       nrow=5,
       ncol=2,
       byrow=TRUE, 
       dimnames=list(c("r1","r2","r3","r4","r5"),
                     c("c1","c2")))
```

### C√≥mo escribir una funci√≥n

##### üß© Ejercicio: consultar la funci√≥n sort()

-   Ordena el vector c(5, 8, 6, 2, 4, 5, NA) usando la funcion sort()

-   Utiliza el argumento "decreasing" para ordenarlo de mayor a menor (consulta la ayuda para ver como se usa este argumento). ¬øQu√© valor tiene por defecto?

-   ¬øQue otro argumento tiene la funcion que especifica detalles de la ejecuci√≥n? C√°mbialo a otro valor que no sea su valor por defecto.

-   ¬øCual es el valor de retorno de la funci√≥n?

```{r}

# nombro el vector
v1<-  c(5, 8, 6, 2, 4, 5, NA)

# lo ordeno usando sort
sort(v1)

# de mayor a menor
sort(v1, decreasing=TRUE) #cambio el valor por defecto (FALSE) a TRUE

# argumento na.last
sort(v1, decreasing=TRUE, na.last=TRUE)

#el valor de retorno de la funcion es el vector ordenado con las espeificaciones que le he dado en los argumentos
```

##### üß© Ejercicio: primera funci√≥n

1.  Crea una funci√≥n que sirva para calcular el √°rea de habitaciones cuadradas o rectangulares. Para ello crea una funci√≥n de dos argumentos (el ancho de la habitaci√≥n y el largo) y que devuelva el √°rea.

```{r habitaciones, eval = FALSE}
mi_funcion <- function(largo, ancho) {
  ancho * largo
}
```

2.  Queremos saber el precio de enlosar la habitaci√≥n. Para ello a√±ade un tercer argumento con el precio por metro cuadrado.

```{r}
mi_funcion <- function(largo, ancho, precio) {
  ancho * largo * precio
}
```

3.  ¬øCuanto cuesta enlosar una habitaci√≥n de 10x16m con un tipo de losa que cuesta 5‚Ç¨ el metro cuadrado? ¬øY una de 32x4m con una que cuesta 16‚Ç¨ por metro cuadrado?

```{r}
mi_funcion(10,16,5)
mi_funcion(32, 4, 16)
```

##### üß© Ejercicio: funcion de media aritm√©tica

Crea una funci√≥n que calcule la media aritm√©tica de los valores de un vector (sin usar la funci√≥n mean()). De tal manera que si introducimos, por ejemplo, el vector c(1, 8, 18) nos devuelva el valor 9

-   Pista1: sum() nos da el valor de la suma de los elementos de un vector \# prueba sum(c(1, 2, 3)) para comprobarlo

Pista 2: length() nos da la longitud (numero de elementos) del vector.

```{r}
mi_media <- function(v) {
  sum(v) / length(v)
}

mi_media(c(10, 5, 2, 14))
```

### Iteraciones con bucles for

##### üß© Ejercicio: creando bucles for

Elige al menos una de las siguientes opciones y crea un bucle:

A partir del vector v\<- c(1,2,3,4), crea un vector w donde el pimer elemento de w sea el primer de v al cuadrado m√°s uno y as√≠ sucesivamente.

```{r}
v <- c(1, 2, 3, 4)
w <- vector("integer", 4)

for (i in 1:length(v)) {
  #tambien i in 1:4; i in seq_along()
  w[[i]] = v[[i]]^2 + 1
}
w
```

-   A partir de una lista con los dataframes de tidyverse msleep, diamonds y mpg, crea una nueva lista donde aparezcan esos mismos dataframes pero seleccionado solo las columnas que empiecen por "c" y las filas de la 10 a la 20.

```{r}
library(tidyverse)
lista_df <- list(msleep, diamonds, mpg)
lista_nueva <- list()

for (i in seq_along(lista_df)) {
  lista_nueva[[i]] <- lista_df[[i]] |> select(starts_with("c")) |> slice(10:20)
}
```

-   Genera un bucle para leer los archivos df1 a df5 de la carpeta data/df y almacenarlos en una lista. Pista: consulta la funcion list.files() y mira cuidadosamente todos los argumentos.

```{r}
lista <- list.files("data/df", full.names = T)
lista_files <- list()

for (i in seq_along(lista)) {
  lista_files[[i]] <- read_delim(lista[[i]])
}
```

### Iteraciones con funcionales

##### üß© Ejercicio: map()

-   Genera un vector, una funci√≥n y aplica la funci√≥n a cada uno de los elementos del vector utilizando `map()`.

```{r}
v2 <- c(5, 6, 8, 9, 11)
operacion <- function(x)
  sqrt(x * 5)
map(v2, operacion)
```

-   para la lista list(a = 1:3, b = letters\[1:5\], c = c(TRUE, FALSE)) utiliza map() para generar una salida que sea una lista con las longitudes de cada elemento. ¬øQue funcion tendr√≠as que utilizar si quieres que la salida sea un vector de n√∫meros enteros en lugar de una lista?

```{r}
l1 <- list(a = 1:3,
           b = letters[1:5],
           c = c(TRUE, FALSE))
map(l1, length)
map_int(l1, length)
```

-   para la lista_num \<- list(a = c(1,2,3), b = c(4,5), c = 6) aplica una funcion de la familia map para obtener la media de cada elemento a, b, c en un vector num√©rico.

```{r}
l2 <- list(a = c(1, 2, 3),
           b = c(4, 5),
           c = 6)
map_dbl(l2, mean)

```

------------------------------------------------------------------------

<details>

<summary>Session Info</summary>

```{r session_info} Sys.time() sessionInfo()}
```

</details>
