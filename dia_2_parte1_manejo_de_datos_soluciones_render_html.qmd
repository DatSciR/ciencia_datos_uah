---
title: "D√≠a 2 - Manejo de datos con Tidyverse. Programa de doctorado UAH - SOLUCIONES"
author: "Marina Rodes Blanco, Paloma Ruiz Benito, Ver√≥nica Cruz Alonso y Juli√°n Tijerin Trivi√±o"
date: today
date-format: "DD/MM/YYYY"
toc: true
toc-depth: 5
toc-title: "√çndice"
format:
  html:
    link-external-newwindow: true
    # css: styles.css
  gfm: default
editor: visual
editor_options: 
  chunk_output_type: console
number-sections: false
---

## S√≠ntesis del d√≠a 1: Introducci√≥n a R y a R studio (POR TERMINAR)

#### üß© Ejercicio: *repaso* *del d√≠a anterior*

-   Crea un vector con los meses del a√±o (en n√∫mero) y calcula la media
-   Crea una matriz ... ¬øCual es el elemento de la fila 3 columna 2?
-   Crea una lista .. ¬øQue hay en el tercer elemento de la lista?
-   Crea un data frame con la siguiente informaci√≥n

```{r solucion ej repaso}
#Pendiente
```

## Importar y renombrar datos

#### üß© *Ejercicio: slice(), filter(), arrange()*

```{=html}
<table>
  <tr>
    <td style="width:330px; vertical-align:top;">
      <img src="images/mammals_sleeping_picture1_copilot.png" style="width:300px; height:auto; display:block;">
    </td>
    <td style="vertical-align:middle;">
      <li> Lee el data.frame ‚Äúmsleep.csv‚Äù. Pista: el delimitador entre datos es la coma (‚Äú,‚Äù).</li>
      <li> Crea un subset que NO contenga los animales dom√©sticos (campo conservation). ¬øCuantas son?</li>
      <li> Crea un subset de datos que contenga las filas de la 1 a la 5 y de la 18 a la 20, sobre esos datos obten los animales carn√≠voros. Ordena seg√∫n las horas de sue√±o ¬øQu√© animal duerme m√°s horas?</li>
    </td>
  </tr>
</table>
```

```{r solucion ejercicio 1}
#Soluci√≥n ejercicio 1: slice(), filter(), arrange()
library (tidyverse)

## Leer el data frame
msleep<- read_delim(file = "data/msleep.csv", delim = ",")

head(msleep)

## Crea un subset que NO contenga los animales dom√©sticos (campo conservation). ¬øCuantas son?

msleep |>  filter(conservation != "domesticated")

#### Otras posibles soluciones...
msleep |>  filter(conservation %in% c("lc", "nt", "vu", "en", "cd",NA))
msleep |>  filter(conservation == "lc" | conservation =="nt" | 
                    conservation == "vu"|conservation == "en"|
                    conservation == "cd"| is.na(conservation))

## Crea un subset de datos que contenga las filas de la 1 a la 5 y de la 18 a la 20, sobre esos datos obten los animales carn√≠voros. Ordena seg√∫n las horas de sue√±o ¬øQu√© animal duerme m√°s horas?

subset_msleep<- msleep |> 
  slice(1:5, 18:20) |>
  filter(vore=="carni") |> 
  arrange(desc(sleep_total))
  
#### solucion: Cheetah (guepardo)

```

### [Select](https://dplyr.tidyverse.org/reference/select.html): sirve para seleccionar columnas utilizando condiciones

#### üß© *Ejercicio: select()*

```{=html}
<table>
  <tr>
    <td style="width:330px; vertical-align:top;">
      <img src="images/mammals_sleeping_picture2_copilot.png" style="width:300px; height:auto; display:block;">
    </td>
    <td style="vertical-align:middle;">
      <li> Con el data set de msleep, crea un nuevo data.frame que contenga las variables relacionadas con el sue√±o.</li>
      <li> Crea un nuevo objeto con el orden, g√©nero y nombre al principio y que incluya todas las dem√°s columnas excepto el tiempo despierto.</li>
      <li>(extra) ¬øQue animal del orden Carnivora en estado vulnerable (conservation = vu) duerme m√°s?</li>
    </td>
  </tr>
</table>
```

```{r solucion ejercicio 2}

## Nuevo data.frame que contenga las variables relacionadas con el sue√±o
head(msleep) #para ver las 10 primeras lineas
names(msleep) #para ver el nombre de las columnas

vars_sleep<-msleep |>
  select(starts_with("sleep"))

## Nuevo objeto con el orden, g√©nero y nombre al principio y que incluya todas las dem√°s columnas excepto el tiempo despierto.
msleep2<- msleep |> 
  select(order, genus, name, everything(), -awake)

## Extra: ¬øQue animal del orden Carnivora en estado vulnerable (conservation = vu) duerme m√°s?

msleep |> 
  filter(order=="Carnivora" &
           conservation =="vu") |>
  arrange(desc(sleep_total))

```

## Transformar los datos y calcular nuevas variables

#### üß© *Ejercicio: mutate()*

```{=html}

<table>
  <tr>
    <td style="width:330px; vertical-align:top;">
      <img src="images/mammals_sleeping_picture3_copilot.png" style="width:300px; height:auto; display:block;">
    </td>
    <td style="vertical-align:middle;">
      <li> Con el data set de msleep, incluye una nueva columna con el porcentaje de horas que duerme cada animal al d√≠a. </li>
      <li> Haz una clasificaci√≥n que incluya tres categor√≠as: carnivoros amenazados, herviboros amenazados y otros. Para ello tienes que basarte en las columnas ‚Äúvore‚Äù y ‚Äúconservation‚Äù. Segun la UICN se considera amenazado cuando est√° en las categor√≠as vulnerable (vu), endangered (en) o critically endangered (cr). </li>
    </td>
  </tr>
</table>
```

```{r solucion ejercicio 3}
## Nueva columna con el porcentaje de horas que duerme cada animal al d√≠a.

msleep |> mutate(sleep_prc=(sleep_total/24)*100)

## Haz una clasificaci√≥n que incluya tres categor√≠as: carnivoros amenazados, herviboros amenazados y otros. Para ello tienes que basarte en las columnas ‚Äúvore‚Äù y ‚Äúconservation‚Äù. Segun la UICN se considera amenazado cuando est√° en las categor√≠as vulnerable (vu), endangered (en) o critically endangered (cd).

msleep |>
  mutate(
    classification = case_when(
      # utilizar varias variables para calcular otra nueva
      vore == "carni" &
        conservation %in% c(
          "en", "cd") ~ "threatened carnivore",
      
      vore == "herbivore" &
        conservation %in% c(
          "en", "cd") ~ "threatened herbivore",
      
      TRUE ~ "others" #resto de casos
    )
  )

```

#### üß© *Ejercicio: group_by(), summarise()*

```{=html}
<table>
  <tr>
    <td style="width:330px; vertical-align:top;">
      <img src="images/mammals_sleeping_picture4_copilot.png" style="width:300px; height:auto; display:block;">
    </td>
    <td style="vertical-align:middle;">
      <li> Con el data set de msleep, cuenta el n√∫mero de especies estudiadas por orden (order) </li>
      <li> Calcula el promedio de horas de sue√±o seg√∫n el tipo de alimentaci√≥n ¬øduemen mas los carnivoros, los herb√≠voros o los insect√≠voros estudiados en este dataset? </li>
    </td>
  </tr>
</table>
```

```{r solucion ejercicio 4}
## Con el data set de msleep, cuenta el n√∫mero de especies estudiadas por orden (order)
msleep |>
  group_by(order) |>
  summarise(species_per_order=n())

## Otra opci√≥n, mucho m√°s segura...
msleep |> 
  group_by(order) |>  
  summarise(species_per_order=n_distinct(name))

## Calcula el promedio de horas de sue√±o seg√∫n el tipo de alimentaci√≥n ¬øduemen mas los carnivoros, los herb√≠voros o los insect√≠voros estudiados en este dataset?


```

#### üß© *Ejercicio: transformar datos largo ancho*

```{=html}
<table>
  <tr>
    <td style="width:330px; vertical-align:top;">
      <img src="images/pixar_image2_flickr.jpg" style="width:300px; height:auto; display:block;">
    </td>
    <td style="vertical-align:middle;">
      <li> Lee el set de datos pixar_public_response_long. En este set de datos se encuentra la puntuaci√≥n de pel√≠culas pixar por la audiencia seg√∫n tres webs diferentes: rotten tomatoes, metacritic y critics‚Äô choice. </li>
      <li> Reorganiza el set de datos para que la puntuaci√≥n de cada una de las webs se encuentre en una columna diferente </li>
      <li> (extra) ¬øCual es el promedio de puntuaci√≥n por pel√≠cula teniendo en cuenta todas las fuentes? ¬øQue pel√≠cula es la mejor y peor puntuada de media? </li>
    </td>
  </tr>
</table>
```

Fuente imagen: <https://www.flickr.com/photos/harshlight/17294952412> (CC BY 2.0)

```{r solucion ejercicio 5}
## Lee el set de datos pixar_public_response_long. En este set de datos se encuentra la puntuaci√≥n de pel√≠culas pixar por la audiencia seg√∫n tres webs diferentes: rotten tomatoes, metacritic y critics‚Äô choice.

pixar_public_response_long<- read_delim("data/pixar_public_response_long.csv")

glimpse(pixar_public_response_long)

head(pixar_public_response_long)

str(pixar_public_response_long)

## Reorganiza el set de datos para que la puntuaci√≥n de cada una de las webs se encuentre en una columna diferente

pixar_public_response_wide<- pivot_wider(pixar_public_response_long,
                                         names_from=source,
                                         values_from=value)

## (extra) ¬øCual es el promedio de puntuaci√≥n por pel√≠cula teniendo en cuenta todas las fuentes? ¬øQue pel√≠cula es la mejor y peor puntuada de media?

pixar_public_response_wide |> 
  mutate(mean_score=(rotten_tomatoes + metacritic + critics_choice)/3) |> 
  filter(mean_score==max(mean_score,na.rm=T) | mean_score==min(mean_score, na.rm=T))

```

## Unir data.frames

#### üß© *Ejercicio: \*\_join() y exportar datos*

```{=html}
<table>
  <tr>
    <td style="width:330px; vertical-align:top;">
      <img src="images/pixar_image3_flickr.jpg" style="width:300px; height:auto; display:block;">
    </td>
    <td style="vertical-align:middle;">
      <li> Lee el set de datos pixar_public_response y pixar_films </li>
      <li> Explora los dos data sets con funciones como head() para ver las primeras lineas, glimpse() o View() </li>
      <li> Une ambos datasets en uno solo para tener en un mismo data frame toda la informaci√≥n. Elige el campo m√°s apropiado de uni√≥n </li>
      <li> Guarda el nuevo set de datos como pixar_joint </li>
    </td>
  </tr>
</table>
```

Fuente imagen: <https://www.flickr.com/photos/harshlight/6988729286> (CC BY 2.0)

```{r solucion ejercicio 6}
## Lee el set de datos pixar_public_response y pixar_films
pixar_public_response <- read_delim("data/pixar_public_response.csv")
pixar_films <- read_delim("data/pixar_films.csv")

## Explora los dos data sets con funciones como head() para ver las primeras lineas, glimpse() o View()
head(pixar_public_response)
glimpse(pixar_public_response)

head(pixar_films)
glimpse(pixar_films)

## Une ambos datasets en uno solo para tener en un mismo data frame toda la informaci√≥n. Elige el campo m√°s apropiado de uni√≥n

pixar_joint <- full_join(pixar_films, pixar_public_response, by = "film")

## Guarda el nuevo set de datos como pixar_joint
write_delim(pixar_joint, file = "data/pixar_joint.csv", delim = ";")
```

## üß© *Ejercicio final*

```{=html}
<table>
  <tr>
    <td style="width:150px; vertical-align:top;">
      <img src="images/palmer_penguins.png" style="width:130px; height:auto; display:block;">
    </td>
    <td style="vertical-align:middle;">
    Queremos estudiar caracter√≠sticas f√≠sicas de los ping√ºinos y relacionarlas con el tipo de isla donde viven. Para ello, realiza las siguientes tareas utilizando exclusivamente funciones del tidyverse:
    </td>
  </tr>
</table>
```

üêß Instala el paquete penguins y c√°rgalo

```{r ejerccio final (1)}
# install.packages("palmerpenguins")
library(palmerpenguins)
```

üêß Crea un data frame denominado islands_info con dos columnas, la primera llamada "island" con los valores "Torgersen", "Biscoe", "Dream" y otra llamada "protected_area" con los valores "Si", "No", "Si"

```{r ejerccio final (2)}
islands_info<-data.frame(island=c("Torgersen", "Biscoe", "Dream"),
                         protected_area=c("Si", "No", "Si"))
```

üêßSelecciona los pinguinos que tengan picos de m√°s de 40mm (bill_length_mm) y que pesen menos de 4.5kg (recuerda que puedes ver m√°s informaci√≥n de tu dataset en ?penguins)

```{r ejerccio final (3)}
penguins_filter<- penguins |> 
  filter(bill_length_mm>40, body_mass_g <4500)
```

üêßDe los datos filtrados conserva √∫nicamente las columnas species, island, bill_length_mm, bill_depth_mm y body_mass_g

```{r ejerccio final (4)}
penguins_select<- penguins_filter |> 
  select(species, island, bill_length_mm , bill_depth_mm,body_mass_g)
```

üêßA√±ade una columna llamada bill_ratio que calcule la relaci√≥n entre longitud y profundidad del pico

```{r ejerccio final (5)}
penguins_mutate<- penguins_select |> 
  mutate(bill_ratio=bill_length_mm/bill_depth_mm)
```

üêßUne el resultado con el dataset islands_info, de forma que cada ping√ºino quede asociado a si su isla es un √°rea protegida.

```{r ejerccio final (6)}
penguins_join<- penguins_mutate |> 
  left_join(islands_info, by="island")
```

üêßCrea una columna categoria_peso con valores "ligero", "medio", "pesado"seg√∫n los umbrales que quieras o, m√°s dificil, con terciles de body_mass (consulta funcion quantile).

```{r ejerccio final (7)}
penguins_class<- penguins_join |> 
  mutate(body_mass_class=case_when(
    body_mass_g <= quantile(body_mass_g, na.rm=T, 0.33) ~ "ligero",
    body_mass_g > quantile(body_mass_g, na.rm=T, 0.33) &
      body_mass_g <= quantile(body_mass_g, na.rm=T, 0.66) ~ "medio",
    body_mass_g > quantile(body_mass_g, na.rm=T, 0.66) ~ "pesado"
  ))
```

üêßSi no lo has hecho, organiza todos los pasos anteriores (excepto cargar el paquete y crear el data frame) en un solo flujo de trabajo

```{r ejerccio final (8)}

penguins2 <- penguins |>
  
  filter(bill_length_mm > 40, body_mass_g < 4500) |>
  
  select(species , island, bill_length_mm , bill_depth_mm, body_mass_g) |>
  
  mutate(bill_ratio = bill_length_mm / bill_depth_mm) |>
  
  left_join(islands_info, by = "island") |>
  
  mutate(
    body_mass_class = case_when(
      body_mass_g <= quantile(body_mass_g, na.rm = T, 0.33) ~ "ligero",
      body_mass_g > quantile(body_mass_g, na.rm = T, 0.33) &
        body_mass_g <= quantile(body_mass_g, na.rm = T, 0.66) ~ "medio",
      body_mass_g > quantile(body_mass_g, na.rm = T, 0.66) ~ "pesado"
    )
  )

```

üêßCuenta cuantos individuos hay ligeros, medios y pesados en zonas protegidas vs zonas no protegidas

```{r ejerccio final (9)}
penguins_class |>  group_by(body_mass_class) |> summarise(n())
```

üêß(EXTRA) Responde a las siguientes preguntas: ¬øCual es la m√°xima relaci√≥n entre longitud y profundidad del pico de los individuos en zonas protegidas? ¬øy no protegidas?

```{r solucion ejercicio final}
penguins_class |> group_by(protected_area) |>  summarise(bill_ratio=max(bill_ratio))

```

------------------------------------------------------------------------

<details>

<summary>Session Info</summary>

```{r session_info}
Sys.time()
sessionInfo()
```

</details>
